---
// src/pages/lessons/[week].astro - Updated with sidebar TOC
import Layout from '../../layouts/Layout.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import MarkdownRenderer from '../../components/MarkdownRenderer';

export async function getStaticPaths() {
  const paths = [];
  for (let week = 1; week <= 60; week++) {
    paths.push({ params: { week: week.toString() } });
  }
  return paths;
}

const { week } = Astro.params;
const weekNumber = parseInt(week);
const currentWeek = weekNumber;

// Determine section
let sectionName = '';
if (weekNumber >= 1 && weekNumber <= 12) {
  sectionName = 'section1-html-css';
} else if (weekNumber >= 13 && weekNumber <= 24) {
  sectionName = 'section2-javascript';
} else if (weekNumber >= 25 && weekNumber <= 36) {
  sectionName = 'section3-backend';
} else if (weekNumber >= 37 && weekNumber <= 48) {
  sectionName = 'section4-react';
}

// Safe function to fetch TOC with error handling
async function fetchTOCSafely(sectionName, weekNumber) {
  try {
    // Only try to fetch if we're in a server environment and have the API
    if (typeof fetch !== 'undefined') {
      const response = await fetch(`${Astro.url.origin}/api/lessons/${sectionName}/week${weekNumber}/toc`);
      if (response.ok) {
        const data = await response.json();
        return data.tocItems || [];
      }
    }
  } catch (error) {
    console.log(`Could not fetch TOC for week ${weekNumber}:`, error.message);
  }
  
  // Return default TOC items
  return [
    { id: "learning-objectives", title: "Learning Objectives", level: 2 },
    { id: "introduction", title: "Introduction", level: 2 },
    { id: "main-concepts", title: "Main Concepts", level: 2 },
    { id: "practical-examples", title: "Practical Examples", level: 2 },
    { id: "hands-on-practice", title: "Hands-on Practice", level: 2 },
    { id: "review-summary", title: "Review & Summary", level: 2 },
    { id: "assignments", title: "Assignments", level: 2 },
    { id: "resources", title: "Additional Resources", level: 2 }
  ];
}

// Safe function to fetch content with error handling
async function fetchContentSafely(sectionName, weekNumber) {
  try {
    if (typeof fetch !== 'undefined') {
      const response = await fetch(`${Astro.url.origin}/api/lessons/${sectionName}/week${weekNumber}/content`);
      if (response.ok) {
        return await response.text();
      }
    }
  } catch (error) {
    console.log(`Could not fetch content for week ${weekNumber}:`, error.message);
  }
  
  return null;
}

// Fetch data safely
let tocItems = [];
let lessonContent = null;

try {
  tocItems = await fetchTOCSafely(sectionName, weekNumber);
  lessonContent = await fetchContentSafely(sectionName, weekNumber);
} catch (error) {
  console.log(`Error fetching lesson data for week ${weekNumber}:`, error);
  tocItems = [
    { id: "learning-objectives", title: "Learning Objectives", level: 2 },
    { id: "introduction", title: "Introduction", level: 2 },
    { id: "main-concepts", title: "Main Concepts", level: 2 },
    { id: "assignments", title: "Assignments", level: 2 }
  ];
}

// Ensure tocItems is always an array
if (!Array.isArray(tocItems)) {
  tocItems = [];
}

// Fetch lesson data
const API_BASE = 'http://localhost:8080/api';
let lesson = null;
let error = null;

try {
  const response = await fetch(`${API_BASE}/lessons/${week}`);
  if (response.ok) {
    lesson = await response.json();
  } else if (response.status === 404) {
    error = 'Lesson not found';
  } else {
    error = 'Failed to load lesson';
  }
} catch (err) {
  console.error('Failed to fetch lesson:', err);
  error = 'Failed to connect to server';
}

// Get all lessons for navigation
let allLessons = [];
try {
  const response = await fetch(`${API_BASE}/lessons`);
  if (response.ok) {
    allLessons = await response.json();
  }
} catch (err) {
  console.error('Failed to fetch all lessons:', err);
}

// Find prev/next lessons
// const currentWeek = parseInt(week);
const prevLesson = allLessons.find(l => l.week === currentWeek - 1);
const nextLesson = allLessons.find(l => l.week === currentWeek + 1);

const tmp = `---
title: "Arrays and Modern JavaScript Methods"
description: "Master array manipulation, iteration methods, and modern JavaScript features for data processing"
week: 18
section: 2
prerequisites: ["Objects", "Functions", "Loops"]
objectives:
  - "Master array creation, manipulation, and transformation methods"
  - "Use modern array methods (map, filter, reduce, forEach)"
  - "Implement functional programming concepts with arrays"
  - "Handle complex data structures and nested arrays"
  - "Apply array methods for real-world data processing"
---

# Week 18: Arrays and Modern JavaScript Methods

## Learning Objectives`

---

<Layout title={`Week ${week} - Course Lesson`}>
  <main class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8">
    <div class="max-w-7xl mx-auto px-4">
      
      <!-- Breadcrumb -->
      <nav class="mb-6">
        <ol class="flex items-center space-x-2 text-sm">
          <li><a href="/" class="text-indigo-600 hover:text-indigo-800">Home</a></li>
          <li class="text-gray-400">/</li>
          <li><a href="/lessons" class="text-indigo-600 hover:text-indigo-800">Lessons</a></li>
          <li class="text-gray-400">/</li>
          <li class="text-gray-600">Week {week}</li>
        </ol>
      </nav>

      <!-- Main Content Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        <!-- Sidebar - Table of Contents -->
        <aside class="lg:col-span-1 order-2 lg:order-1">
          <TableOfContents 
            weekNumber={weekNumber} 
            tocItems={tocItems}
            className="lg:sticky lg:top-4"
          />
          
          <!-- Week Navigation -->
          <div class="mt-6 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <h4 class="font-semibold text-gray-900 mb-3">Navigate Weeks</h4>
            <div class="flex flex-col space-y-2">
              {weekNumber > 1 && (
                <a 
                  href={`/lessons/${weekNumber - 1}`}
                  class="flex items-center px-3 py-2 text-sm text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-md transition-colors"
                >
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                  Week {weekNumber - 1}
                </a>
              )}
              
              <a 
                href="/lessons"
                class="flex items-center px-3 py-2 text-sm text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-md transition-colors"
              >
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                </svg>
                All Lessons
              </a>
              
              {weekNumber < 48 && (
                <a 
                  href={`/lessons/${weekNumber + 1}`}
                  class="flex items-center px-3 py-2 text-sm text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-md transition-colors"
                >
                  Week {weekNumber + 1}
                  <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </a>
              )}
            </div>
          </div>
        </aside>

        <!-- Main Content Area -->
        <div class="lg:col-span-3 order-1 lg:order-2">
          
          <!-- Lesson Header -->
          <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                  Week {week} Lesson Lesson
                </h1>
                <p class="text-gray-600">
                  {sectionName.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                </p>
              </div>
              
              <!-- Mobile TOC Toggle Button -->
              <button 
                id="mobile-toc-toggle"
                class="lg:hidden px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                </svg>
              </button>
            </div>
          </div>

      <!-- Lesson Content -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
              <!-- {lesson.content ? () : ()} -->
              {lesson.content ? (
              <div class="markdown-content">
                <MarkdownRenderer content={lesson.content} client:load />
              </div>
              ) : (
                <MarkdownRenderer content={tmp} client:load />
              )}



             
            </div>

            <div class="prose max-w-none">
              <!-- Sample content structure that matches typical TOC -->
              
              <h2 id="learning-objectives">Learning Objectives</h2>
              <p>By the end of this week, you will be able to...</p>
              <ul>
                <li>Understand core concepts</li>
                <li>Apply practical skills</li>
                <li>Complete hands-on exercises</li>
              </ul>

              <h2 id="day-1-introduction">Day 1: Introduction</h2>
              <p>Today we'll start with the fundamentals...</p>

              <h2 id="day-2-fundamentals">Day 2: Fundamentals</h2>
              <p>Building on yesterday's introduction...</p>

              <h2 id="day-3-practice">Day 3: Practice</h2>
              <p>Time to put theory into practice...</p>

              <h2 id="day-4-advanced">Day 4: Advanced Topics</h2>
              <p>Now let's explore more advanced concepts...</p>

              <h2 id="day-5-review">Day 5: Review</h2>
              <p>Let's review everything we've learned...</p>

              <h2 id="assignments">Assignments</h2>
              <p>Complete the following assignments...</p>

              <h2 id="resources">Additional Resources</h2>
              <p>Here are some helpful resources for further learning...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  // Mobile TOC toggle functionality
  document.addEventListener('DOMContentLoaded', function() {
    const toggleButton = document.getElementById('mobile-toc-toggle');
    const sidebar = document.querySelector('aside');
    
    if (toggleButton && sidebar) {
      toggleButton.addEventListener('click', function() {
        sidebar.classList.toggle('hidden');
        sidebar.classList.toggle('block');
      });
    }
  });
</script>

<style>
  /* Mobile TOC styles */
  @media (max-width: 1024px) {
    aside {
      @apply fixed top-0 left-0 z-50 w-80 h-full bg-white shadow-xl transform -translate-x-full transition-transform duration-300 p-6 overflow-y-auto;
    }
    
    aside.block {
      @apply translate-x-0;
    }
    
 
  }
</style>